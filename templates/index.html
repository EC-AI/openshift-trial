{% extends "templates/base.html" %}
{% block content %}
    <p>
    Take a screenshot of a Sudoku puzzle: <br/>
    <form action="/solve" enctype="multipart/form-data" method="post">
      <input type="hidden" name="sudoku" id="sudoku"><br>
      <button type="button" id="screenshot-button">Take!</button>
      <input type="submit" value="Solve" id="solve">
    </form>
    </p>

    <p>
      Or, upload a puzzle image: <br/>
      <form action="/solve_upld" enctype="multipart/form-data" method="post">
        <input type="file" name="sudoku"><br>
        <input type="submit" value="Solve">
       </form>
    </p>

    <video id="screenshot-stream" width="640" height="480" autoplay></video>
    <img id="screenshot" src="">
    <canvas id="screenshot-canvas" style="display:none;"></canvas>

<script>
function errorCallback(e) {
  if (e.code == 1) {
    alert('User denied access to their camera');
  } else {
    alert('getUserMedia() not supported in your browser.');
  }
}

var sudoku = document.querySelector('#sudoku');
var video = document.querySelector('#screenshot-stream');
var button = document.querySelector('#screenshot-start-stop');
var screenshot_button = document.querySelector('#screenshot-button');
var canvas = document.querySelector('#screenshot-canvas');
var img = document.querySelector('#screenshot');
var ctx = canvas.getContext('2d');
var localMediaStream = null;


function sizeCanvas() {
  // video.onloadedmetadata not firing in Chrome so we have to hack.
  // See crbug.com/110938.
  setTimeout(function() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    img.height = video.videoHeight;
    img.width = video.videoWidth;
  }, 100);
}


function snapshot() {
  ctx.drawImage(video, 0, 0);
  img.src = canvas.toDataURL('image/png');
  sudoku.value = canvas.toDataURL('image/png');
}


screenshot_button.addEventListener('click', function(e) {
  if (localMediaStream) {
    snapshot();
    return;
  }
}, false);


if (navigator.getUserMedia) {
  navigator.getUserMedia('video', function(stream) {
    video.src = stream;
    localMediaStream = stream;
    sizeCanvas();
  }, errorCallback);
} else if (navigator.webkitGetUserMedia) {
  navigator.webkitGetUserMedia({video: true}, function(stream) {
    video.src = window.URL.createObjectURL(stream);
    localMediaStream = stream;
    sizeCanvas();
  }, errorCallback);
} else {
  errorCallback({target: video});
}

video.addEventListener('click', snapshot, false);
// TODO: add a corresponding handler for the snapshot to post the form and solve the puzzle

</script>
{% endblock %}
